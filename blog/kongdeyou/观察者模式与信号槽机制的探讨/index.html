<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>观察者模式与信号槽机制的探讨 | HUA Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="观察者模式与信号槽机制的探讨 | HUA Blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="很抱歉，您访问的页面不存在，看看其他的文章呢？ 如果您对出现该页面有疑惑，或之前该网址链接有内容，可以反馈到邮箱：&#x74;&#x69;&#115;&#x2e;&#x61;&#x63;&#x2e;&#x63;&#110;&#64;&#111;&#117;&#x74;&#x6c;&#x6f;&#x6f;&#x6b;&#x2e;&#x63;&#111;&#109;。 访问主页  访问关于">
<meta property="og:type" content="website">
<meta property="og:title" content="404 (Not Found) - 该页面无法显示">
<meta property="og:url" content="https://blog.kdyx.net/404.html">
<meta property="og:site_name" content="HUA Blog">
<meta property="og:description" content="很抱歉，您访问的页面不存在，看看其他的文章呢？ 如果您对出现该页面有疑惑，或之前该网址链接有内容，可以反馈到邮箱：&#x74;&#x69;&#115;&#x2e;&#x61;&#x63;&#x2e;&#x63;&#110;&#64;&#111;&#117;&#x74;&#x6c;&#x6f;&#x6f;&#x6b;&#x2e;&#x63;&#111;&#109;。 访问主页  访问关于">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-30T15:00:00.000Z">
<meta property="article:modified_time" content="2024-04-04T03:53:39.528Z">
<meta property="article:author" content="HUA Blog">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="HUA Blog" type="application/atom+xml">
</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>HUA Blog</span>
</div>

<div class="icon">
    
        
            <a title="email"
               href="mailto:ti.studio@foxmail.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/ninetalesfox"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(50)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="开发杂记">
            <i class="fold iconfont icon-right"></i>
            开发杂记
            <small>(3)</small>
        </div>
        
            <ul class="sub hide">
                
                    
    <li>
        <div data-rel="开发杂记&lt;---&gt;CV/CG">
            
            CV/CG
            <small>(3)</small>
        </div>
        
    </li>

                
            </ul>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="工具杂记">
            
            工具杂记
            <small>(2)</small>
        </div>
        
    </li>

            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="50">
<input type="hidden" id="yelog_site_word_count" value="96.3k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://www.kindem.xyz/">Kindem</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索[快捷键(i)]"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图[快捷键(w)]"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Hair</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>MySQL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PicGo</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>TressFX</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>发丝</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>图床</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>忘记密码</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数字人</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数据库</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>毛发渲染</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>物理模拟</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 开发杂记 CV/CG "
           href="/blog/kongdeyou/hair_simulation_and_rendering_3/"
           data-tag="Hair,毛发渲染,物理模拟,数字人,发丝,TressFX"
           data-author="kongdeyou" >
            <span class="post-title" title="保姆级毛发算法调研分析，十万长文带你深入TressFX（三）">保姆级毛发算法调研分析，十万长文带你深入TressFX（三）</span>
            <span class="post-date" title="2022-06-22 23:33:58">2022/06/22</span>
        </a>
        
        
        <a  class="全部文章 开发杂记 CV/CG "
           href="/blog/kongdeyou/hair_simulation_and_rendering_2/"
           data-tag="Hair,毛发渲染,物理模拟,数字人,发丝,TressFX"
           data-author="kongdeyou" >
            <span class="post-title" title="保姆级毛发算法调研分析，十万长文带你深入TressFX（二）">保姆级毛发算法调研分析，十万长文带你深入TressFX（二）</span>
            <span class="post-date" title="2022-06-03 23:18:22">2022/06/03</span>
        </a>
        
        
        <a  class="全部文章 开发杂记 CV/CG "
           href="/blog/kongdeyou/hair_simulation_and_rendering/"
           data-tag="Hair,毛发渲染,物理模拟,数字人,发丝,TressFX"
           data-author="kongdeyou" >
            <span class="post-title" title="保姆级毛发算法调研分析，十万长文带你深入TressFX（一）">保姆级毛发算法调研分析，十万长文带你深入TressFX（一）</span>
            <span class="post-date" title="2022-05-29 21:40:12">2022/05/29</span>
        </a>
        
        
        <a  class="全部文章 工具杂记 "
           href="/blog/kongdeyou/find_forget_sql_password/"
           data-tag="MySQL,数据库,忘记密码"
           data-author="kongdeyou" >
            <span class="post-title" title="忘记MySQL数据库密码解决方案">忘记MySQL数据库密码解决方案</span>
            <span class="post-date" title="2022-03-20 17:45:00">2022/03/20</span>
        </a>
        
        
        <a  class="全部文章 工具杂记 "
           href="/blog/kongdeyou/make_picture_bed_by_picgo_and_github/"
           data-tag="图床,PicGo"
           data-author="kongdeyou" >
            <span class="post-title" title="超香之PicGo+Github搭建免费图床">超香之PicGo+Github搭建免费图床</span>
            <span class="post-date" title="2022-03-20 16:12:00">2022/03/20</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/3d_rendering_farplane_zfighting/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="3D渲染中远处物体Z-Fighting(闪烁)问题">3D渲染中远处物体Z-Fighting(闪烁)问题</span>
            <span class="post-date" title="2021-11-28 22:39:00">2021/11/28</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/commandqueue_commandlist_commandallocator/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="渲染三大金刚——CommandQueue、CommandList、CommandAllocator之间的关系梳理">渲染三大金刚——CommandQueue、CommandList、CommandAllocator之间的关系梳理</span>
            <span class="post-date" title="2021-11-19 19:27:00">2021/11/19</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/cpp_concurrency_01/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="C++并发编程01-管理线程">C++并发编程01-管理线程</span>
            <span class="post-date" title="2021-11-19 00:22:00">2021/11/19</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/cpp_concurrency_00/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="C++并发编程00-并发世界">C++并发编程00-并发世界</span>
            <span class="post-date" title="2021-11-19 00:11:00">2021/11/19</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/%E8%BD%AC%E6%88%98%E9%80%BC%E4%B9%8E%E5%A3%B0%E6%98%8E/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="转战逼乎声明 :-)">转战逼乎声明 :-)</span>
            <span class="post-date" title="2021-11-18 23:26:00">2021/11/18</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/why_lock_avoids_deadlock/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="为什么std::lock能避免死锁">为什么std::lock能避免死锁</span>
            <span class="post-date" title="2021-09-15 22:35:00">2021/09/15</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/static_warning_in_cpp/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="实现一个C++的static_warning">实现一个C++的static_warning</span>
            <span class="post-date" title="2021-09-01 23:35:00">2021/09/01</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/yexin/cross_compile_cunit_and_ctest_on_qnx/"
           data-tag=""
           data-author="yexin" >
            <span class="post-title" title="QNX交叉编译CUnit+CTest">QNX交叉编译CUnit+CTest</span>
            <span class="post-date" title="2021-08-25 20:14:00">2021/08/25</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/auto_disk_copier/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="一个倾注灵魂的U盘小偷">一个倾注灵魂的U盘小偷</span>
            <span class="post-date" title="2021-08-21 17:28:00">2021/08/21</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/speed_up_the_download_of_vscode_and_git/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="解决vscode和git国内下载速度太慢">解决vscode和git国内下载速度太慢</span>
            <span class="post-date" title="2021-08-10 12:58:00">2021/08/10</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/windows_essentials_software_recommendations_for_developers/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Windows开发机装机利器安利存档（持续更新）">Windows开发机装机利器安利存档（持续更新）</span>
            <span class="post-date" title="2021-07-29 23:29:00">2021/07/29</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/action_executor/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="我撸了一个函数执行包装器后发现……">我撸了一个函数执行包装器后发现……</span>
            <span class="post-date" title="2021-07-25 23:55:00">2021/07/25</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/head_only_singleton_implementation/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="实现一个head-only库中能用的singleton和静态成员变量模板">实现一个head-only库中能用的singleton和静态成员变量模板</span>
            <span class="post-date" title="2021-07-23 21:57:00">2021/07/23</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/the_relationship_of_cryengine_lumberyard_o3de/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="CryEngine、Lumberyard、O3DE的关系">CryEngine、Lumberyard、O3DE的关系</span>
            <span class="post-date" title="2021-07-23 19:23:00">2021/07/23</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/the_error_of_future_is_destructible/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="未定义的类不允许作为编译器内部类型特征“__is_destructible”的参数--问题解决记录">未定义的类不允许作为编译器内部类型特征“__is_destructible”的参数--问题解决记录</span>
            <span class="post-date" title="2021-07-21 23:04:00">2021/07/21</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/new_experience_of_drawing_with_drawio/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="drawio画图新体验">drawio画图新体验</span>
            <span class="post-date" title="2021-07-19 11:30:00">2021/07/19</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/yexin/gitlab%E7%9A%84pipeline%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/"
           data-tag=""
           data-author="yexin" >
            <span class="post-title" title="Gitlab的Pipeline执行机制">Gitlab的Pipeline执行机制</span>
            <span class="post-date" title="2021-07-05 20:53:00">2021/07/05</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/yexin/windows%E4%B8%8A%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8repo/"
           data-tag=""
           data-author="yexin" >
            <span class="post-title" title="Windows上安装使用repo">Windows上安装使用repo</span>
            <span class="post-date" title="2021-07-05 19:18:00">2021/07/05</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/game_server_framework_cpp_and_python/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="游戏服务器框架之C++使用Python脚本">游戏服务器框架之C++使用Python脚本</span>
            <span class="post-date" title="2021-06-20 12:18:00">2021/06/20</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/database_of_kbe/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="游戏服务器数据库及kbEngine中的数据库">游戏服务器数据库及kbEngine中的数据库</span>
            <span class="post-date" title="2021-06-10 22:10:00">2021/06/10</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/lumberyard_gridmate/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Lumberyard通讯组件GridMate浅析">Lumberyard通讯组件GridMate浅析</span>
            <span class="post-date" title="2021-05-30 22:04:00">2021/05/30</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/vs_performance_profiler/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="使用Visual Studio性能探查器定位性能瓶颈">使用Visual Studio性能探查器定位性能瓶颈</span>
            <span class="post-date" title="2021-05-23 22:25:00">2021/05/23</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/github_action/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="体验GitHub的CI构建工具Action">体验GitHub的CI构建工具Action</span>
            <span class="post-date" title="2021-05-22 23:03:00">2021/05/22</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/format_msi/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="从msi安装包文件中获取属性数据实现安装包的重命名">从msi安装包文件中获取属性数据实现安装包的重命名</span>
            <span class="post-date" title="2021-05-09 12:30:00">2021/05/09</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/game_server_history/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="游戏服务器发展历程">游戏服务器发展历程</span>
            <span class="post-date" title="2021-04-25 23:51:00">2021/04/25</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/google_sitemap_cannot_fetch/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Google站长平台设置Sitemap显示“无法获取”的问题">Google站长平台设置Sitemap显示“无法获取”的问题</span>
            <span class="post-date" title="2021-04-10 00:39:00">2021/04/10</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/research_of_game_team/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="全功能游戏团队协作流程">全功能游戏团队协作流程</span>
            <span class="post-date" title="2021-04-03 00:42:00">2021/04/03</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/about_my_drawing_in_the_blog/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="关于在博客中的画图">关于在博客中的画图</span>
            <span class="post-date" title="2021-04-02 20:37:00">2021/04/02</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/smash/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="论文翻译：Palazzi-engine-iscc16（SMASH：分布式游戏引擎体系结构）">论文翻译：Palazzi-engine-iscc16（SMASH：分布式游戏引擎体系结构）</span>
            <span class="post-date" title="2021-03-31 20:40:00">2021/03/31</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/technical_research_of_roblox/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Roblox技术调研总结">Roblox技术调研总结</span>
            <span class="post-date" title="2021-03-28 22:48:00">2021/03/28</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/hlslcc_unreal_simple/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Unreal-HLSLCC概览">Unreal-HLSLCC概览</span>
            <span class="post-date" title="2021-03-21 21:06:00">2021/03/21</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/use_cmake_to_generate_constant_string/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="利用CMake生成代码中的常量字符串">利用CMake生成代码中的常量字符串</span>
            <span class="post-date" title="2021-03-21 18:39:00">2021/03/21</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/yexin/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%9D%8E%E5%9D%B7%E7%9A%84%E7%BB%8F%E5%8E%86-%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85-net3-5/"
           data-tag=""
           data-author="yexin" >
            <span class="post-title" title="记录一次坎坷的经历——离线安装.net3.5">记录一次坎坷的经历——离线安装.net3.5</span>
            <span class="post-date" title="2021-03-16 12:05:00">2021/03/16</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/comment_on_how_to_avoid_getting_into_involution_for_programmers/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="评《程序员该怎么避免陷入内卷》">评《程序员该怎么避免陷入内卷》</span>
            <span class="post-date" title="2021-03-08 22:19:00">2021/03/08</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/shader_cross_platform_compile_mssc/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Shader跨平台编译：MS-SC">Shader跨平台编译：MS-SC</span>
            <span class="post-date" title="2021-02-17 22:40:00">2021/02/17</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/shader_cross_platform_compile_unity/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Shader跨平台编译：Unity">Shader跨平台编译：Unity</span>
            <span class="post-date" title="2021-02-17 20:59:00">2021/02/17</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/shader_cross_platform_compile_unreal/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Shader跨平台编译：Unreal">Shader跨平台编译：Unreal</span>
            <span class="post-date" title="2021-02-17 17:12:00">2021/02/17</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/shader_cross_platform_compile/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Shader跨平台编译">Shader跨平台编译</span>
            <span class="post-date" title="2021-02-16 18:58:00">2021/02/16</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/apache_server_donot_list_directories/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Apache服务器配置禁止列出目录">Apache服务器配置禁止列出目录</span>
            <span class="post-date" title="2021-01-30 15:45:00">2021/01/30</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/imagewatch/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="开发调试工具ImageWatch-查看内存中的图像">开发调试工具ImageWatch-查看内存中的图像</span>
            <span class="post-date" title="2021-01-25 17:40:00">2021/01/25</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BF%A1%E5%8F%B7%E6%A7%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%8E%A2%E8%AE%A8/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="观察者模式与信号槽机制的探讨">观察者模式与信号槽机制的探讨</span>
            <span class="post-date" title="2021-01-02 11:17:00">2021/01/02</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E5%8F%98%E9%87%8F%E7%9A%84settergetter_qt%E7%89%88/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="实现自动生成变量的Setter&amp;Getter(Qt版)">实现自动生成变量的Setter&amp;Getter(Qt版)</span>
            <span class="post-date" title="2020-12-19 22:28:00">2020/12/19</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/windows%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E5%AE%9E%E5%BD%95/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="Windows服务器博客搭建实录">Windows服务器博客搭建实录</span>
            <span class="post-date" title="2020-12-13 14:30:00">2020/12/13</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/msvc%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8F%91%E5%B8%83%E5%8C%85%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="MSVC运行时发布包下载链接">MSVC运行时发布包下载链接</span>
            <span class="post-date" title="2020-12-01 23:30:00">2020/12/01</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/blog/kongdeyou/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E5%8A%A0%E8%BD%BD%E5%99%A8/"
           data-tag=""
           data-author="kongdeyou" >
            <span class="post-title" title="动态链接库加载器">动态链接库加载器</span>
            <span class="post-date" title="2020-11-28 17:00:00">2020/11/28</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏[快捷键(s)]">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-blog/kongdeyou/观察者模式与信号槽机制的探讨" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">观察者模式与信号槽机制的探讨</h1>
    
    <div class="article-meta">
        
        
        <span class="author"><a>kongdeyou</a></span>
        
        
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2024-04-04 11:53:39'>2021-01-02 11:17</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:6k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BF%A1%E5%8F%B7%E6%A7%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%8E%A2%E8%AE%A8"><span class="toc-text">观察者模式与信号槽机制的探讨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">观察者模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%A7%BD%E6%9C%BA%E5%88%B6"><span class="toc-text">信号槽机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-text">传统观察者模式实现方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%A7%BD%E7%BB%99%E6%88%91%E4%BB%AC%E5%B8%A6%E6%9D%A5%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-text">信号槽给我们带来了什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%A7%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">信号槽实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SignalSlot%E2%80%94%E2%80%94%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%8Bsigslot"><span class="toc-text">SignalSlot——封装一下sigslot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9sigslot%E9%80%9A%E8%BF%87%E7%BC%96%E8%AF%91"><span class="toc-text">修改sigslot通过编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E9%80%9A%E7%94%A8%E7%9A%84%E4%BF%A1%E5%8F%B7%E6%A8%A1%E6%9D%BF%E7%B1%BB"><span class="toc-text">更通用的信号模板类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8C%81%E9%A3%8E%E6%A0%BC%E7%BB%9F%E4%B8%80"><span class="toc-text">保持风格统一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="toc-text">线程安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%9A%84Emit-Connect-Disconnect%E5%87%BD%E6%95%B0"><span class="toc-text">全局的Emit&amp;Connect&amp;Disconnect函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8D%9F%E8%80%97"><span class="toc-text">性能损耗</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SignalSlot%E2%80%94%E2%80%94%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-text">SignalSlot——完整代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SignalSlot-hpp"><span class="toc-text">SignalSlot.hpp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%8B%E4%B8%AA%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E5%9C%BA%E6%99%AF"><span class="toc-text">看个例子：智能家居场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE"><span class="toc-text">协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">后记</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-6 i,
    .toc-level-6 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="观察者模式与信号槽机制的探讨"><a href="#观察者模式与信号槽机制的探讨" class="headerlink" title="观察者模式与信号槽机制的探讨"></a>观察者模式与信号槽机制的探讨</h1><p>观察者模式与信号槽机制之间的关系，可以套用哲学里的世界观与方法论之间的关系。说人话？ <strong>观察者模式</strong>是设计模式中的一种，是<strong>理论基础</strong>，而<strong>信号槽机制</strong>是观察者模式的一种实现，是<strong>工程实践</strong>。</p>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>维基百科对观察者模式的解释：观察者模式是软件设计模式的一种，在该种模式中，一个目标对象管理所有相依于它的观察者对象，并在它本身的状态改变时主动发出通知，通知所有的观察者。这通常通过调用各观察者所提供的方法来实现。该模式通常被用在实时事件处理系统中。（下图图片来源：维基百科）</p>
<p><img src="https://cdn.jsdelivr.net/gh/TiEngine/PictureBed@latest/kongdeyou/wp-content/uploads/2021/09/pic_observer_pattern_class_diagram.png" alt="Observer-pattern-class-diagram.png"></p>
<p>观察者模式中的对象有：<strong>被观察者（或称为目标对象）</strong>、<strong>观察者</strong>。一个被观察者可以被多个观察者所观察，观察者向被观察者注册观察，当被观察者的状态发生改变时，将通知所有注册了观察的观察者，观察者也可以断开对被观察者的观察，不再接受被观察者状态改变的通知。</p>
<p>观察者模式的形象解释是：一个用来展示价格数据（状态）的平台（被观察者），我（观察者）在这个平台上留下了手机号并开启了通知（注册观察），当价格发生改变时我会收到短信通知，同时其他在平台上留下了手机号并开启了通知的人（其他观察者）也能收到短信通知（被观察者状态改变，通知所有注册观察的观察者），当我退订了短信通知（断开观察），价格再发生改变时我将不再收到短信通知，而其他没有退订通知的人仍然还能收到通知。</p>
<h2 id="信号槽机制"><a href="#信号槽机制" class="headerlink" title="信号槽机制"></a>信号槽机制</h2><p>信号槽机制可以理解为一种遵循观察者模式的对象间通信手段，当某个对象的状态发生变化时，触发该对象的一个信号，另外一些对象的槽函数绑定了该信号，信号的触发将导致执行这些槽函数，完成对象之间的通信。</p>
<h3 id="传统观察者模式实现方式"><a href="#传统观察者模式实现方式" class="headerlink" title="传统观察者模式实现方式"></a>传统观察者模式实现方式</h3><p>传统的观察者模式的实现需要开发人员&#x2F;既关注观察者&#x2F;还需要关注被观察者，通过&#x2F;在&#x2F;被观察者中&#x2F;注册&#x2F;观察者的状态改变回调函数&#x2F;来实现&#x2F;被观察者状态改变时通知观察者&#x2F;的目的。（加入了分隔符方便阅读理解）</p>
<p>这种实现方式下，观察者模式中的观察者和被观察者是糅合在一起的，开发人员在编码时需要分散精力理顺概念和逻辑，然后才能写出符合要求的代码，即整个项目的架构通过要求开发者来保持，如果开发者的功力不够，很容易把项目的大架构写搓。</p>
<p>同时，传统的实现方式在观察者销毁时，会在被观察者中留下一个已经失效的函数指针，为了移除这个指针，开发人员往往需要手动断开观察或是在观察者的析构函数中断开观察（此步骤需要调用被观察者的函数），这一过程要求开发人员参与，在实际工程中有可能会出现开发人员忘记收尾的情景。</p>
<h3 id="信号槽给我们带来了什么"><a href="#信号槽给我们带来了什么" class="headerlink" title="信号槽给我们带来了什么"></a>信号槽给我们带来了什么</h3><p>信号槽实现了新的一套观察者模式，由信号槽框架维护关联性、处理收尾工作，整体呈现一个松耦合的架构，使得代码层级分明及模块独立，使用灵活方便，易于拓展及维护，开发人员能够聚焦于具体的业务而无需再关心观察者模式的框架，被观察者只关注状态变化，观察者只关注观察对象状态变化后的处理逻辑。这样在应用开发前的设计阶段，设计好架构并确定好信号和槽的对接后，项目将变成可分解的小需求，这时候就能<em>投入人力并行开发（解除阻塞大大缩短开发周期）</em>。</p>
<p>信号槽也有弊端，信号槽框架维系着信号和槽之间的联系，响应速度不及回调函数指针，在极端的性能场景会受影响。同时槽函数内是允许继续发出信号的，如果使用不当，会造成信号槽死循环。另外，信号槽在运行时的调试具有一定的挑战性，也正是因为信号槽机制的松耦合特性，如果没有好好设计需要扔的信号和接收的槽，会导致“信号满天飞”和“一地鸡篮槽”，如果没有一个好的设计文档罗列出信号和槽的关联，不去深入读代码很难知道整个系统中某一个信号有什么槽函数在什么时候和它相连接了，这些对于问题的定位、新人加入项目组都有挑战。</p>
<p>（PS：Qt有一个非官方的调试工具gammaray，解决了信号槽松耦合特性下信号与槽割裂的问题，能够运行时实时观测信号槽的联系，事实上gammaray还实现了许多针对Qt的硬核调试工具）</p>
<h2 id="信号槽实现"><a href="#信号槽实现" class="headerlink" title="信号槽实现"></a>信号槽实现</h2><p>在这篇文章中，我不打算写手撸一个信号槽的过程，当然造一个轮子对理解和领悟能更上一层楼（也很有意思）。本着做工程的思想，如果有现有的成熟好用的轮子且经过时间和各种项目的检验，开源协议又友好，用这样的轮子自然比手撸一个还要后期投入去维护更能节省成本和专注于工程本身。</p>
<p>调研一下现有的成熟信号槽实现（事实上有不少的信号槽实现项目，但以下几个的名声和使用度最高）：</p>
<table border="1">
<thead>
<tr>
<th style="text-align: center;">信号槽实现</th>
<th style="text-align: center;">Qt</th>
<th style="text-align: center;">boost</th>
<th style="text-align: center;">libsigc++</th>
<th style="text-align: center;">sigslot</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">返回值</td>
<td style="text-align: center;">直联模式支持</td>
<td style="text-align: center;">有</td>
<td style="text-align: center;">有</td>
<td style="text-align: center;">无</td>
</tr>
<tr>
<td style="text-align: center;">信号实体</td>
<td style="text-align: center;">成员函数</td>
<td style="text-align: center;">对象</td>
<td style="text-align: center;">对象</td>
<td style="text-align: center;">对象</td>
</tr>
<tr>
<td style="text-align: center;">线程安全</td>
<td style="text-align: center;">有（指定参数）</td>
<td style="text-align: center;">有（独立实现）</td>
<td style="text-align: center;">无</td>
<td style="text-align: center;">有（指定参数）</td>
</tr>
<tr>
<td style="text-align: center;">类型安全</td>
<td style="text-align: center;">是，运行期检查</td>
<td style="text-align: center;">是，编译期检查</td>
<td style="text-align: center;">是，编译期检查</td>
<td style="text-align: center;">是，编译期检查</td>
</tr>
<tr>
<td style="text-align: center;">参数列表</td>
<td style="text-align: center;">允许 信号≥槽</td>
<td style="text-align: center;">要求一致</td>
<td style="text-align: center;">要求一致</td>
<td style="text-align: center;">要求一致</td>
</tr>
<tr>
<td style="text-align: center;">实现方式</td>
<td style="text-align: center;">moc预编译</td>
<td style="text-align: center;">C++</td>
<td style="text-align: center;">C++</td>
<td style="text-align: center;">C++</td>
</tr>
</tbody>
</table>

<p>Qt的核心思想是它最引以为豪的信号槽机制，Qt的信号槽功能强大容错性极好，有内省机制，有Qt完善友好的界面工具支持，但是Qt的信号槽机制需要依赖于它自己的moc预编译，需要有Qt的一套编译工具链才能工作。boost的信号槽boost::signals依赖于其他的boost模块，需要引入整个boost库，线程安全的信号槽独立实现在boost::signals2中，太过厚重，多线程替换不够友好。libsigc++的开源协议是LGPL，需要做动态链接库隔离或进程隔离，对商用不够友好。sigslot库是head-only的，而且遵循公共开放开源协议（无任何限制的协议），对任何形式的使用都十分的友好，OK就是它了！</p>
<h2 id="SignalSlot——封装一下sigslot"><a href="#SignalSlot——封装一下sigslot" class="headerlink" title="SignalSlot——封装一下sigslot"></a>SignalSlot——封装一下sigslot</h2><h3 id="修改sigslot通过编译"><a href="#修改sigslot通过编译" class="headerlink" title="修改sigslot通过编译"></a>修改sigslot通过编译</h3><p>如果直接集成sigslot编译，会出现类似如下的错误。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1&gt;------ 已启动生成: 项目: SignalSlot, 配置: Debug Win32 ------</span><br><span class="line">1&gt; SignalSlotTest.cpp</span><br><span class="line">1&gt; signalslot\sigslot-1-0-0\sigslot\sigslot.h(419): warning C4346: “const_iterator”: 依赖名称不是类型</span><br><span class="line">1&gt; signalslot\sigslot-1-0-0\sigslot\sigslot.h(419): note: 用“typename”为前缀来表示类型</span><br><span class="line">1&gt; signalslot\sigslot-1-0-0\sigslot\sigslot.h(476): note: 参见对正在编译的类 模板 实例化“sigslot::has_slots&lt;mt_policy&gt;”的引用</span><br><span class="line">1&gt; signalslot\sigslot-1-0-0\sigslot\sigslot.h(419): error C2061: 语法错误: 标识符“const_iterator”</span><br><span class="line">1&gt; signalslot\sigslot-1-0-0\sigslot\sigslot.h(419): error C2238: 意外的标记位于“;”之前</span><br><span class="line">========== 生成: 成功 0 个，失败 1 个，最新 0 个，跳过 0 个 ==========</span><br></pre></td></tr></table></figure>

<p>问题发生在第419行。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> sender_set::const_iterator const_iterator;</span><br></pre></td></tr></table></figure>

<p>只是一个简单的语法错误，意义是准确的，对于非模板是能通过编译的。</p>
<p>但是此处应用于模板中，sender_set是一个模板类类型。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> std::set&lt;_signal_base&lt;mt_policy&gt; *&gt; sender_set;</span><br></pre></td></tr></table></figure>

<p>根据错误提示，我们需要使用typename前缀来表示模板类型，修改该句即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">typename</span> sender_set::const_iterator const_iterator;</span><br></pre></td></tr></table></figure>

<h3 id="更通用的信号模板类"><a href="#更通用的信号模板类" class="headerlink" title="更通用的信号模板类"></a>更通用的信号模板类</h3><p>sigslot的信号模板类型是signalx，x是槽函数参数的个数，同时我们还会在模板参数列表中将所有的参数类型依次列出。事实上，我们在将参数类型依次列出时，就能够得知槽函数的参数个数了，没有必要再多此一举在信号模板类型中加一个x。因此在封装时把它封装起来吧。</p>
<p>sigslot仅支持最多8个槽函数参数，我们可以拓展sigslot的代码来支持更多的槽函数参数个数，但过多的参数是一种代码坏味道，会降低代码的质量，影响可测试性等等。我们一般限定一个函数的参数个数不超过5个，8个完全足够我们使用了。我们定义SignalTemplate模板类，并采用模板特例化的方法，特例化有0~8个槽函数参数的情景，并用静态断言禁止槽函数参数个数多于8个。由于8种特例化的过程十分类似，我们用宏来简化重复的代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> argsCount, <span class="keyword">class</span> ...Args&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SignalTemplate</span> &#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="keyword">sizeof</span>...(Args) &lt;= <span class="number">8</span>,</span><br><span class="line">        <span class="string">&quot;SignalTemplate: only &lt;= 8 args are supported.&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_TEMPLATE_FUNCTION_IMPLEMENT_                        \</span></span><br><span class="line"><span class="meta">inline void Emit(const Args&amp; ...args)                               \</span></span><br><span class="line"><span class="meta">&#123;                                                                   \</span></span><br><span class="line"><span class="meta">    signal.emit(args...);                                           \</span></span><br><span class="line"><span class="meta">&#125;                                                                   \</span></span><br><span class="line"><span class="meta">template<span class="string">&lt;typename DestObj&gt;</span>                                          \</span></span><br><span class="line"><span class="meta">inline void Connect(DestObj* object, void(DestObj::*slot)(Args...)) \</span></span><br><span class="line"><span class="meta">&#123;                                                                   \</span></span><br><span class="line"><span class="meta">    signal.connect(object, slot);                                   \</span></span><br><span class="line"><span class="meta">&#125;                                                                   \</span></span><br><span class="line"><span class="meta">template<span class="string">&lt;typename DestObj&gt;</span>                                          \</span></span><br><span class="line"><span class="meta">inline void Disconnect(DestObj* object)                             \</span></span><br><span class="line"><span class="meta">&#123;                                                                   \</span></span><br><span class="line"><span class="meta">    signal.disconnect(object);                                      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_TEMPLATE_VARIABLE_IMPLEMENT_(argsCount)             \</span></span><br><span class="line"><span class="meta">sigslot::signal##argsCount<span class="string">&lt;Args...&gt;</span> signal;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_TEMPLATE_IMPLEMENT_(n)      \</span></span><br><span class="line"><span class="meta">template<span class="string">&lt;class ...Args&gt;</span>                     \</span></span><br><span class="line"><span class="meta">class SignalTemplate<span class="string">&lt;n, Args...&gt;</span> &#123;          \</span></span><br><span class="line"><span class="meta">public:                                     \</span></span><br><span class="line"><span class="meta">    _SIGNAL_TEMPLATE_FUNCTION_IMPLEMENT_    \</span></span><br><span class="line"><span class="meta">private:                                    \</span></span><br><span class="line"><span class="meta">    _SIGNAL_TEMPLATE_VARIABLE_IMPLEMENT_(n) \</span></span><br><span class="line"><span class="meta">&#125;;</span></span><br><span class="line"></span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">0</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">1</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">2</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">3</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">4</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">5</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">6</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">7</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<p>Signal类含有SignalTemplate类，我们用sizeof…(Args)获取模板类型列表个数，来对应特例化的SignalTemplate类。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Signal</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Signal</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Signal</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// COPY &amp; MOVE construction are not allowed.</span></span><br><span class="line">    <span class="built_in">Signal</span>(Signal <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Signal</span>(Signal &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Signal&amp; <span class="keyword">operator</span>=(Signal <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Signal&amp; <span class="keyword">operator</span>=(Signal &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Emit</span><span class="params">(<span class="type">const</span> Args&amp; ...args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        st.<span class="built_in">Emit</span>(args...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span> <span class="title">Connect</span><span class="params">(DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        st.<span class="built_in">Connect</span>(object, slot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(DestObj* object)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        st.<span class="built_in">Disconnect</span>(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    SignalTemplate&lt;<span class="keyword">sizeof</span>...(Args), Args...&gt; st;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样最终对外暴露的Signal类就只有模板参数列表了，不论x是多少，都采用通用的Signal类。</p>
<h3 id="保持风格统一"><a href="#保持风格统一" class="headerlink" title="保持风格统一"></a>保持风格统一</h3><p>为了保持风格的统一，我们再来包装一下sigslot::has_slots基类。有槽函数的类需要继承自sigslot的has_slots基类，在析构时，has_slots会自动断开所有的连接槽，这个过程由has_slots的析构函数来完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Object</span> : <span class="keyword">public</span> sigslot::has_slots&lt;&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line">    ~<span class="built_in">Object</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// COPY &amp; MOVE construction are not allowed.</span></span><br><span class="line">    <span class="built_in">Object</span>(Object <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Object</span>(Object &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Object&amp; <span class="keyword">operator</span>=(Object <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Object&amp; <span class="keyword">operator</span>=(Object &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如上，我们包装了一个Object类继承自sigslot::has_slots&lt;&gt;，事实上这个类并没有做什么:-)</p>
<p>我们在Connect和Disconnect内使用静态断言来确保模板类型继承自Object类，它帮助我们在静态编译期确保逻辑正确。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Signal</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span> <span class="title">Connect</span><span class="params">(DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">static_assert</span>(std::<span class="built_in">is_base_of</span>&lt;Object, DestObj&gt;(),</span><br><span class="line">            <span class="string">&quot;Template is not base of Object&quot;</span>);</span><br><span class="line">        st.<span class="built_in">Connect</span>(object, slot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(DestObj* object)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">static_assert</span>(std::<span class="built_in">is_base_of</span>&lt;Object, DestObj&gt;(),</span><br><span class="line">            <span class="string">&quot;Template is not base of Object&quot;</span>);</span><br><span class="line">        st.<span class="built_in">Disconnect</span>(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><p>sigslot原生支持多线程和线程安全，通过在包含头文件前定义宏SIGSLOT_DEFAULT_MT_POLICY来使用不同的线程模式。定义该宏需要知道不同的线程模式，我们简单包装一下它。</p>
<p>默认情况下，我们使用单线程模式，信号槽不保证线程安全，但不需要加锁，速度快。 如果定义了<code>SIGNAL_SLOT_MULTI_THREADS_SINGLE_MUTEX</code>宏，我们使用多线程单一锁模式，线程安全，在全局只使用一个锁，所有信号共用同一个锁。 如果定义了<code>SIGNAL_SLOT_MULTI_THREADS_MULTI_MUTEXS</code>宏，我们使用多线程多锁模式，线程安全，针对每个信号使用独立的锁。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined SIGNAL_SLOT_MULTI_THREADS_SINGLE_MUTEX</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSLOT_DEFAULT_MT_POLICY multi_threaded_global</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined SIGNAL_SLOT_MULTI_THREADS_MULTI_MUTEXS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSLOT_DEFAULT_MT_POLICY multi_threaded_local</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSLOT_DEFAULT_MT_POLICY single_threaded</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>槽函数内的执行过程是不保证线程安全的，比如一个槽函数连接了两个在不同线程的信号，两个信号被先后触发，几乎同时运行了该槽函数，如果槽函数对类内数据有操作，此时有线程安全问题。</p>
<p>我们可以使用<code>SIGNAL_SLOT_LOCK</code>和<code>SIGNAL_SLOT_UNLOCK</code>宏来对访问加解锁确保对类内数据操作是安全有序的。 我们也可以使用<code>SIGNAL_SLOT_LOCK_BLOCK</code>宏，该宏替换后的lock_block采用RAII特性实现了一个生命周期锁，实例化（构造）时加锁，生命周期结束（析构）时解锁。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------------- !!!! NB !!!! ---------------</span></span><br><span class="line"><span class="comment">// Thread safety is not guaranteed between slots,</span></span><br><span class="line"><span class="comment">// but you can use:</span></span><br><span class="line"><span class="comment">//   &quot;SIGNAL_SLOT_LOCK;/SIGNAL_SLOT_UNLOCK;&quot; or</span></span><br><span class="line"><span class="comment">//   &quot;SIGNAL_SLOT_LOCK_BLOCK;&quot;(RAII)</span></span><br><span class="line"><span class="comment">// in slot function to ensure multi-thread safety.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_SLOT_LOCK       lock()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_SLOT_UNLOCK     unlock()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_SLOT_LOCK_BLOCK lock_block<span class="string">&lt;SIGSLOT_DEFAULT_MT_POLICY&gt;</span> lock(this)</span></span><br></pre></td></tr></table></figure>

<h3 id="全局的Emit-Connect-Disconnect函数"><a href="#全局的Emit-Connect-Disconnect函数" class="headerlink" title="全局的Emit&amp;Connect&amp;Disconnect函数"></a>全局的Emit&amp;Connect&amp;Disconnect函数</h3><p>sigslot的connect、disconnect、emit函数都是写在信号类(signalx)里的，我们在使用时是调用信号对象实例的函数来进行操作。如果使用过Qt，我们会发现Qt的这些函数是写在QObject基类里的，我们在使用时是直接在类中调用connect&amp;disconnect函数和使用emit宏来完成操作。</p>
<p>这两种方式很难说哪种用法更好。sigslot的信号实体是一个对象，因此写在了信号类中；Qt的信号实体是一个成员函数，需要通过moc预编译器来生成真正的函数定义，因此写在了QObject基类中。</p>
<p>而从我的观点出发，我希望将这些函数直接放在全局空间（或直接放在SignalSlot命名空间）内，而不是在某一个类中。</p>
<p>正向论证： 信号槽机制的很大一个功能点是解耦，信号和槽是隔离的，对于使用者而言，信号不需要关注有什么槽连接了自己，槽也只关注自己的实现，而Connect、Disconnect、Emit函数是信号与槽间的桥梁，割裂的关系通过这三个函数联系了起来，因此无论把它们放在哪方的类中都不太合适。</p>
<p>反向论证： 如果我们直接采用sigslot的方式，在使用时总是需要拎着信号到处调用函数，虽然本质上是解耦的，但编码上看起来像是总由信号在主导一切，直观的解耦感受不够强烈。 如果我们学习Qt放在QObject里，假设有三个类A、B、C，A中有一个信号，C中有一个槽，我们能在B类中去将C类的槽连接到A类中的信号上，调用的是B类中的connect函数，虽然是一个static函数，但是这个过程和B类有什么关系呢，放在QObject里就会导致这种奇怪的逻辑，如果把connect脱离出来放在信号槽之外的全局空间，逻辑就不奇怪了，实际架构中B类有可能是一个中间人的角色，是有实际意义的。</p>
<p>因此，放过它们吧，直接放在全局空间里。实在有冲突，整个SignalSlot命名空间包装一下。</p>
<p>为了实现全局的Emit&amp;Connect&amp;Disconnect函数，我们在Signal类中定义友元函数，并将原先在Signal类中对sigslot包装的Emit、Connect、Disconnect函数调整为private属性，然后定义全局的Emit、Connect、Disconnect函数，在全局的函数中转调Signal内的函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Signal</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt; <span class="keyword">friend</span> <span class="type">void</span> <span class="title">Emit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Signal&lt;Args...&gt;&amp; signal, <span class="type">const</span> Args&amp; ...args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="keyword">friend</span> <span class="type">void</span> <span class="title">Connect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Signal&lt;Args...&gt;&amp; signal, DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="keyword">friend</span> <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Signal&lt;Args...&gt;&amp; signal, DestObj* object)</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt; <span class="type">void</span> <span class="title">Emit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Signal&lt;Args...&gt;&amp; signal, <span class="type">const</span> Args&amp; ...args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal.<span class="built_in">Emit</span>(args...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="type">void</span> <span class="title">Connect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Signal&lt;Args...&gt;&amp; signal, DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal.<span class="built_in">Connect</span>(object, slot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Signal&lt;Args...&gt;&amp; signal, DestObj* object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal.<span class="built_in">Disconnect</span>(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="性能损耗"><a href="#性能损耗" class="headerlink" title="性能损耗"></a>性能损耗</h3><p>我们对sigslot封装了一层，内部的复杂度提升了，但是对外接口的逻辑清晰了些，也符合了我项目中的编程风格。我们把性能优化任务留给了编译器，让编译器帮我们“擦屁股”。在Release模式下，这层封装的转调基本都会被优化掉，几乎没有性能损失。</p>
<h2 id="SignalSlot——完整代码"><a href="#SignalSlot——完整代码" class="headerlink" title="SignalSlot——完整代码"></a>SignalSlot——完整代码</h2><h3 id="SignalSlot-hpp"><a href="#SignalSlot-hpp" class="headerlink" title="SignalSlot.hpp"></a>SignalSlot.hpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// MIT License</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Copyright (c) 2021 kongdeyou(https://tis.ac.cn/blog/author/kongdeyou/)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Permission is hereby granted, free of charge, to any person obtaining a copy</span></span><br><span class="line"><span class="comment">// of this software and associated documentation files (the &quot;Software&quot;), to deal</span></span><br><span class="line"><span class="comment">// in the Software without restriction, including without limitation the rights</span></span><br><span class="line"><span class="comment">// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></span><br><span class="line"><span class="comment">// copies of the Software, and to permit persons to whom the Software is</span></span><br><span class="line"><span class="comment">// furnished to do so, subject to the following conditions:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The above copyright notice and this permission notice shall be included in all</span></span><br><span class="line"><span class="comment">// copies or substantial portions of the Software.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></span><br><span class="line"><span class="comment">// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></span><br><span class="line"><span class="comment">// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></span><br><span class="line"><span class="comment">// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></span><br><span class="line"><span class="comment">// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></span><br><span class="line"><span class="comment">// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span></span><br><span class="line"><span class="comment">// SOFTWARE.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SIGNAL_SLOT_HPP_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_SLOT_HPP_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined SIGNAL_SLOT_MULTI_THREADS_SINGLE_MUTEX</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSLOT_DEFAULT_MT_POLICY multi_threaded_global</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined SIGNAL_SLOT_MULTI_THREADS_MULTI_MUTEXS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSLOT_DEFAULT_MT_POLICY multi_threaded_local</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSLOT_DEFAULT_MT_POLICY single_threaded</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sigslot-1-0-0/sigslot/sigslot.h&quot;</span></span></span><br><span class="line"><span class="comment">// --------------- !!!! NB !!!! ---------------</span></span><br><span class="line"><span class="comment">// Thread safety is not guaranteed between slots,</span></span><br><span class="line"><span class="comment">// but you can use:</span></span><br><span class="line"><span class="comment">//   &quot;SIGNAL_SLOT_LOCK;/SIGNAL_SLOT_UNLOCK;&quot; or</span></span><br><span class="line"><span class="comment">//   &quot;SIGNAL_SLOT_LOCK_BLOCK;&quot;(RAII)</span></span><br><span class="line"><span class="comment">// in slot function to ensure multi-thread safety.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_SLOT_LOCK       lock()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_SLOT_UNLOCK     unlock()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGNAL_SLOT_LOCK_BLOCK lock_block<span class="string">&lt;SIGSLOT_DEFAULT_MT_POLICY&gt;</span> lock(this)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Object</span> : <span class="keyword">public</span> sigslot::has_slots&lt;&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line">    ~<span class="built_in">Object</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// COPY &amp; MOVE construction are not allowed.</span></span><br><span class="line">    <span class="built_in">Object</span>(Object <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Object</span>(Object &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Object&amp; <span class="keyword">operator</span>=(Object <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Object&amp; <span class="keyword">operator</span>=(Object &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> argsCount, <span class="keyword">class</span> ...Args&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SignalTemplate</span> &#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="keyword">sizeof</span>...(Args) &lt;= <span class="number">8</span>,</span><br><span class="line">        <span class="string">&quot;SignalTemplate: only &lt;= 8 args are supported.&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_TEMPLATE_FUNCTION_IMPLEMENT_                        \</span></span><br><span class="line"><span class="meta">inline void Emit(const Args&amp; ...args)                               \</span></span><br><span class="line"><span class="meta">&#123;                                                                   \</span></span><br><span class="line"><span class="meta">    signal.emit(args...);                                           \</span></span><br><span class="line"><span class="meta">&#125;                                                                   \</span></span><br><span class="line"><span class="meta">template<span class="string">&lt;typename DestObj&gt;</span>                                          \</span></span><br><span class="line"><span class="meta">inline void Connect(DestObj* object, void(DestObj::*slot)(Args...)) \</span></span><br><span class="line"><span class="meta">&#123;                                                                   \</span></span><br><span class="line"><span class="meta">    signal.connect(object, slot);                                   \</span></span><br><span class="line"><span class="meta">&#125;                                                                   \</span></span><br><span class="line"><span class="meta">template<span class="string">&lt;typename DestObj&gt;</span>                                          \</span></span><br><span class="line"><span class="meta">inline void Disconnect(DestObj* object)                             \</span></span><br><span class="line"><span class="meta">&#123;                                                                   \</span></span><br><span class="line"><span class="meta">    signal.disconnect(object);                                      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_TEMPLATE_VARIABLE_IMPLEMENT_(argsCount)             \</span></span><br><span class="line"><span class="meta">sigslot::signal##argsCount<span class="string">&lt;Args...&gt;</span> signal;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGNAL_TEMPLATE_IMPLEMENT_(n)      \</span></span><br><span class="line"><span class="meta">template<span class="string">&lt;class ...Args&gt;</span>                     \</span></span><br><span class="line"><span class="meta">class SignalTemplate<span class="string">&lt;n, Args...&gt;</span> &#123;          \</span></span><br><span class="line"><span class="meta">public:                                     \</span></span><br><span class="line"><span class="meta">    _SIGNAL_TEMPLATE_FUNCTION_IMPLEMENT_    \</span></span><br><span class="line"><span class="meta">private:                                    \</span></span><br><span class="line"><span class="meta">    _SIGNAL_TEMPLATE_VARIABLE_IMPLEMENT_(n) \</span></span><br><span class="line"><span class="meta">&#125;;</span></span><br><span class="line"></span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">0</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">1</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">2</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">3</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">4</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">5</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">6</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">7</span>)</span><br><span class="line">_SIGNAL_TEMPLATE_IMPLEMENT_(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Signal</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Signal</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Signal</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// COPY &amp; MOVE construction are not allowed.</span></span><br><span class="line">    <span class="built_in">Signal</span>(Signal <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Signal</span>(Signal &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Signal&amp; <span class="keyword">operator</span>=(Signal <span class="type">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Signal&amp; <span class="keyword">operator</span>=(Signal &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt; <span class="keyword">friend</span> <span class="type">void</span> <span class="title">Emit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Signal&lt;Args...&gt;&amp; signal, <span class="type">const</span> Args&amp; ...args)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="keyword">friend</span> <span class="type">void</span> <span class="title">Connect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Signal&lt;Args...&gt;&amp; signal, DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="keyword">friend</span> <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Signal&lt;Args...&gt;&amp; signal, DestObj* object)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Emit</span><span class="params">(<span class="type">const</span> Args&amp; ...args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        st.<span class="built_in">Emit</span>(args...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span> <span class="title">Connect</span><span class="params">(DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">static_assert</span>(std::<span class="built_in">is_base_of</span>&lt;Object, DestObj&gt;(),</span><br><span class="line">            <span class="string">&quot;Template is not base of Object&quot;</span>);</span><br><span class="line">        st.<span class="built_in">Connect</span>(object, slot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">inline</span> <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(DestObj* object)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">static_assert</span>(std::<span class="built_in">is_base_of</span>&lt;Object, DestObj&gt;(),</span><br><span class="line">            <span class="string">&quot;Template is not base of Object&quot;</span>);</span><br><span class="line">        st.<span class="built_in">Disconnect</span>(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SignalTemplate&lt;<span class="keyword">sizeof</span>...(Args), Args...&gt; st;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ...Args&gt; <span class="type">void</span> <span class="title">Emit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Signal&lt;Args...&gt;&amp; signal, <span class="type">const</span> Args&amp; ...args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal.<span class="built_in">Emit</span>(args...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="type">void</span> <span class="title">Connect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Signal&lt;Args...&gt;&amp; signal, DestObj* object, <span class="type">void</span>(DestObj::*slot)(Args...))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal.<span class="built_in">Connect</span>(object, slot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DestObj, <span class="keyword">class</span> ...Args&gt; <span class="type">void</span> <span class="title">Disconnect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Signal&lt;Args...&gt;&amp; signal, DestObj* object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal.<span class="built_in">Disconnect</span>(object);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="看个例子：智能家居场景"><a href="#看个例子：智能家居场景" class="headerlink" title="看个例子：智能家居场景"></a>看个例子：智能家居场景</h2><p>假设我们有一个智能灯，家里有一个智能家居家庭控制中心，控制中心能实时展示当前智能灯的状态（开&#x2F;关），通过控制中心我们能够控制智能灯的状态，我们还有一个手机端应用，手机端应用上也能实时展示和控制智能灯的状态。我们来构建这样的智能家居场景的服务端。</p>
<p>首先是智能家居场景中的设备，这里只有一个智能灯。我们定义一个House类，存储智能灯的状态<code>lightStatus</code>，智能灯状态发生改变时扔出信号<code>LightStatus</code>，同时有接口函数<code>SetLightStatus</code>和<code>GetLightStatus</code>。调用SetLightStatus函数会改变智能灯的状态并扔出信号。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">House</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Signal&lt;<span class="type">bool</span>&gt; LightStatus;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetLightStatus</span><span class="params">(<span class="type">bool</span> on)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        lightStatus = on;</span><br><span class="line">        ... <span class="comment">// 控制智能灯改变状态</span></span><br><span class="line">        <span class="built_in">Emit</span>(LightStatus, lightStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">GetLightStatus</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lightStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">bool</span> lightStatus = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后我们看看处理手机端的代码，手机端处理中要响应智能灯的状态改变，当智能灯状态改变后通知手机端去更新手机端上智能灯状态的显示。因此，我们在Mobile中写一个<code>LightStatusChanged</code>槽函数实现通知手机端更新智能灯状态的显示，在构造函数中将该槽函数连接到house.LightStatus信号上。此外，我们还写了一个<code>SetLightStatus</code>函数，我们在后面会在接收到移动端请求改变智能灯状态的数据后，调用该函数，该函数最终会调用House类中的SetLightStatus真正改变智能灯的状态并扔出信号。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Mobile</span> : <span class="keyword">public</span> Object &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Mobile</span><span class="params">(House&amp; house)</span></span></span><br><span class="line"><span class="function">        : house(house)</span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">        <span class="built_in">Connect</span>(house.LightStatus, <span class="keyword">this</span>, &amp;Mobile::LightStatusChanged);</span><br><span class="line">        <span class="comment">// 智能家居手机端初始化</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LightStatusChanged</span><span class="params">(<span class="type">bool</span> on)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 更新手机端上智能灯状态的显示</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetLightStatus</span><span class="params">(<span class="type">bool</span> on)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        house.<span class="built_in">SetLightStatus</span>(on);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    House&amp; house;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制中心的基本的操作框架也是类似的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Center</span> : <span class="keyword">public</span> Object &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Center</span><span class="params">(House&amp; house)</span></span></span><br><span class="line"><span class="function">        : house(house)</span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">        <span class="built_in">Connect</span>(house.LightStatus, <span class="keyword">this</span>, &amp;Center::LightStatusChanged);</span><br><span class="line">        <span class="comment">// 智能家居家庭控制中心初始化</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">LightStatusChanged</span><span class="params">(<span class="type">bool</span> on)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 更新家庭控制中心显示面板上的智能灯状态的显示</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetLightStatus</span><span class="params">(<span class="type">bool</span> on)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        house.<span class="built_in">SetLightStatus</span>(on);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    House&amp; house;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最后是消息循环，我们循环去获取手机端和控制中心是否有控制数据传输过来。如果有改变智能灯状态的控制数据，我们会调用相应的mobile或center设置智能灯的状态，然后house中的LightStatus信号会被发送出来，mobile和house都连接了该信号，此时会运行mobile和house中的LightStatusChanged槽函数，更新各自的状态显示。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    House house;</span><br><span class="line"></span><br><span class="line">    <span class="function">Mobile <span class="title">mobile</span><span class="params">(house)</span></span>;</span><br><span class="line">    <span class="function">Center <span class="title">center</span><span class="params">(house)</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line">        <span class="type">bool</span> mobileChangedLightStatus = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> mobileLightStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取手机端数据</span></span><br><span class="line">        <span class="built_in">ReceiveMobileData</span>(&amp;mobileChangedLightStatus, &amp;mobileLightStatus);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mobileChangedLightStatus) &#123;</span><br><span class="line">            mobile.<span class="built_in">SetLightStatus</span>(mobileLightStatus);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line">        <span class="type">bool</span> centerChangedLightStatus = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> centerLightStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取家庭控制中心数据</span></span><br><span class="line">        <span class="built_in">ReceiveCenterData</span>(&amp;centerChangedLightStatus, &amp;centerLightStatus);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (centerChangedLightStatus) &#123;</span><br><span class="line">            center.<span class="built_in">SetLightStatus</span>(centerLightStatus);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><p>本文以上内容遵循CC BY-ND 4.0协议，署名-禁止演绎。</p>
<p>本文中所提供的源代码遵循MIT开源协议。 代码托管于：<a target="_blank" rel="noopener" href="https://github.com/KondeU/SignalSlot">https://github.com/KondeU/SignalSlot</a><br>代码仓中含有演示示例代码。</p>
<p>转载请注明出处：<a target="_blank" rel="noopener" href="https://tis.ac.cn/blog/kongdeyou/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BF%A1%E5%8F%B7%E6%A7%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%8E%A2%E8%AE%A8/">https://tis.ac.cn/blog/kongdeyou/观察者模式与信号槽机制的探讨/</a><br>并署名：<a target="_blank" rel="noopener" href="https://tis.ac.cn/blog/author/kongdeyou/">kongdeyou(https://tis.ac.cn/blog/author/kongdeyou/)</a></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>2021年1月1日 周五 晴</p>
<p>本命年第一天去拔智齿:-(</p>
<p>完稿于2021年1月3日22:22</p>

      
       
    </div>
</article>


<div class="article_copyright">
    <!-- 
    <p><span class="copy-title">文章标题:</span>观察者模式与信号槽机制的探讨</p>
    <p><span class="copy-title">字数:</span><span class="post-count">6k</span></p>
    <p><span class="copy-title">本文作者:</span><a  title="HUA Blog">HUA Blog</a></p>
    <p><span class="copy-title">发布时间:</span>2021-01-02, 11:17:00</p>
    <p><span class="copy-title">最后更新:</span>2024-04-04, 11:53:39</p>
    -->
    <span class="copy-title">原始链接:</span><a class="post-url" href="/blog/kongdeyou/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BF%A1%E5%8F%B7%E6%A7%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%8E%A2%E8%AE%A8/" title="观察者模式与信号槽机制的探讨">https://blog.kdyx.net/blog/kongdeyou/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E4%B8%8E%E4%BF%A1%E5%8F%B7%E6%A7%BD%E6%9C%BA%E5%88%B6%E7%9A%84%E6%8E%A2%E8%AE%A8/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" title="CC BY-NC-ND 4.0 International" target = "_blank">&#34;CC BY-NC-ND 4.0&#34; 署名-不可商用-禁止演绎</a> 转载请注明原文链接及作者信息，侵权必究。
    </p>
</div>



<p>
    <a class="dashang" onclick="dashangToggle()">赏</a>
</p>


    <div id="comments">
<script>
{
    const comments = document.getElementById('comments');
    const script = document.createElement('script');
    script.src = 'https://utteranc.es/client.js';
    script.setAttribute('repo', "ninetalesfox/ninetalesfox.github.io");
    script.setAttribute('issue-term', "title");
    script.setAttribute('theme', "github-light");
    script.setAttribute('label', "utteranc");
    script.setAttribute('crossorigin', 'anonymous');
    script.setAttribute('async', '');
    comments.appendChild(script)
}
</script>
</div>







    </div>
    <div class="copyright">
        <p class="footer-entry"><span class="miit">
                <img src="/img/gov.png" title="中华人民共和国工业和信息化部">
                <a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">苏ICP备2020069368号-1</a>
        </span>
    
    ©2020-2024 HUA Blog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏[快捷键(s)]"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢或有帮助？赞赏下作者呗！</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
    #post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>







</html>
